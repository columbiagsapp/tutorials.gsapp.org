<?php



function gsapp_tutorials_api_node_view($node, $view_mode, $langcode) {

  //$node->content['foobar'] = 88;
  //  $strBody = $node->content['body'][0]['#markup'];
  //$node->content['body'][0]['#markup'] = 'gsapp additional text' . $strBody;

  $question_answer_data = array();

  /* format:

    question
      q-nid
      q-title
      q-body
      q-user
      q-posted
      
      answer
        answer-nid
        answer-body
        answer-user
        answer-posted
      answer
      answer


  */
  

  foreach($node->field_questions_reference['und'] as $key=>$value) {
    $q_node = $value['node'];
    $question_data = array(
      'nid'       => $q_node->nid,
      'dom_id'    => 'q-' . $q_node->nid,
      'title'     => $q_node->title,
      'body'      => $q_node->field_description['und'][0]['safe_value'],
      'uid'       => $q_node->uid,
      'username'  => $q_node->name,
      'created'    => $q_node->created,
      'answers'   => array()
    );

    $answer_nids = $q_node->field_answers_reference['und'];
    
    foreach($answer_nids as $answer) {
      //watchdog('gsapp', 'found answer: ' . serialize($answer));
      //watchdog('gsapp', 'found answer NID: ' . $a_nid);
      $answer_node = node_load($answer['nid'], NULL, True);
      //watchdog('gsapp', 'found answer n: ' . serialize($answer_node));
      $question_data['answers'][] = array(
        'answer_nid'    => $answer_node->nid,
        'dom_nid'       => 'a-' + $answer_node->nid,
        'body'          => $answer_node->body['und'][0]['safe_value'],
        'uid'           => $answer_node->uid,
        'username'      => $answer_node->name,
        'created'       => $answer_node->created
      );
    }
    $question_answer_data[] = $question_data;
  }


  //watchdog('gsapp', 'data:' .serialize($question_answer_data));
  $node->content['field_qa_data']['und'][0]['value'] = serialize($question_answer_data);

}